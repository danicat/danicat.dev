{{ $page_context := . }}
{{ $disableImageOptimization := $page_context.Page.Site.Params.disableImageOptimization | default false }}

{{ $href := $page_context.RelPermalink }}
{{ $is_external := false }}
{{ with $page_context.Params.externalUrl }}
  {{ $href = . }}
  {{ $is_external = true }}
{{ end }}

{{ $featured_image_resource := "" }}
{{ $image_alt_text := $page_context.Title }}

{{- with $page_context.Params.images -}}
  {{/* Use first image from front matter if available */}}
  {{ $featured_image_resource = $page_context.Resources.GetMatch (index . 0) }}
{{- else -}}
  {{- $images := $page_context.Resources.ByType "image" -}}
  {{- $featured_image_resource = $images.GetMatch "*feature*" -}}
  {{- if not $featured_image_resource }}{{ $featured_image_resource = $images.GetMatch "{*cover*,*thumbnail*}" }}{{ end -}}
  {{- if and $page_context.Params.featureimage (not $featured_image_resource) -}}
    {{- $url := $page_context.Params.featureimage -}}
    {{/* Attempt to fetch as page resource first, then remote */}}
    {{- $featured_image_resource = $page_context.Resources.GetMatch $url -}}
    {{- if not $featured_image_resource }}{{ $featured_image_resource = resources.GetRemote $url }}{{ end -}}
  {{- end -}}
  {{- if not $featured_image_resource }}{{ with $page_context.Site.Params.defaultFeaturedImage }}{{ $featured_image_resource = resources.Get . }}{{ end }}{{ end -}}
{{- end -}}

{{ if $page_context.Params.hideFeatureImage }}{{ $featured_image_resource = false }}{{ end }}


<a href="{{ $href }}"
   class="featured-post-card-custom-link"
   {{ if $is_external }}target="_blank" rel="external"{{ end }}>
  <div class="featured-post-card-custom">
    {{ if $featured_image_resource }}
      <div class="image-container">
        {{ $image_to_render := $featured_image_resource }}
        {{ if not $disableImageOptimization }}
          {{/* Resize to a reasonable width for a card, e.g., 800px wide, aspect ratio handled by CSS */}}
          {{ $image_to_render = $featured_image_resource.Resize "800x" }}
        {{ end }}
        <img src="{{ $image_to_render.RelPermalink }}" alt="{{ $image_alt_text }}">
      </div>
    {{ end }}

    <div class="text-content">
      <h2>{{ $page_context.Title | emojify }}</h2>

      <div class="meta">
        {{ partial "article-meta/basic.html" $page_context }}
      </div>

      {{ $show_summary := $page_context.Params.showSummary | default ($page_context.Site.Params.list.showSummary | default false) }}
      {{ if $show_summary }}
        <p class="summary">{{ $page_context.Summary | plainify | truncate 150 }}</p>
      {{ end }}
    </div>

    {{ if and $page_context.Draft $page_context.Site.Params.article.showDraftLabel }}
      <span style="position: absolute; top: 10px; right: 10px; background-color: #ffc107; padding: 2px 5px; font-size: 0.8em; border-radius: 3px;">
        {{ i18n "article.draft" | emojify }}
      </span>
    {{ end }}
  </div>
</a>
